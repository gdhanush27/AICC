<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Registration Form - AICC Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-dashboard">
    <nav class="admin-nav">
        <div class="nav-brand">
            <i class="fas fa-shield-alt"></i>
            AICC Admin Panel
        </div>
        <div class="nav-actions">
            <button id="theme-toggle" class="btn-theme">
                <i class="fas fa-sun"></i>
            </button>
            <a href="{{ url_for('admin_dashboard') }}" class="btn-back">
                <i class="fas fa-arrow-left"></i>
                Dashboard
            </a>
            <a href="{{ url_for('admin_logout') }}" class="btn-logout">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </nav>
    
    <div class="admin-container">
        <div class="admin-header">
            <h1>Edit Registration Form</h1>
            <p>Update form fields and settings</p>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }}"></i>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

<div class="form-container">
    <form method="POST" id="registrationFormEditor">
        <div class="form-section">
            <h3>Basic Information</h3>
            
            <div class="form-group">
                <label for="name">Template Name *</label>
                <input type="text" id="name" name="name" class="form-control" required 
                       value="{{ form.name }}">
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" class="form-control" rows="2" 
                          placeholder="Brief description of when to use this template">{{ form.description if form.description else '' }}</textarea>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="active" value="true" {% if form.active %}checked{% endif %}> Active Template
                </label>
                <small class="form-text">Template is available for use in events</small>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="payment_enabled" id="paymentEnabled" value="true" 
                           {% if form.payment_enabled %}checked{% endif %} onchange="togglePaymentSettings()"> Enable Payment
                </label>
                <small class="form-text">Require payment for registration (Razorpay integration)</small>
            </div>
            
            <div id="paymentSettings" style="display: {% if form.payment_enabled %}block{% else %}none{% endif %};">
                <div class="form-group">
                    <label for="paymentAmount">Payment Amount (â‚¹) *</label>
                    <input type="number" id="paymentAmount" name="payment_amount" class="form-control" 
                           value="{{ form.payment_amount if form.payment_amount else '' }}" 
                           min="1" step="0.01" placeholder="100">
                </div>
                
                <div class="form-group">
                    <label for="paymentDescription">Payment Description</label>
                    <input type="text" id="paymentDescription" name="payment_description" class="form-control" 
                           value="{{ form.payment_description if form.payment_description else '' }}" 
                           placeholder="Event registration fee">
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Form Fields</h3>
            <div id="fieldsContainer"></div>
            <button type="button" class="btn btn-secondary" onclick="addField()">
                <i class="fas fa-plus"></i> Add Field
            </button>
        </div>

        <input type="hidden" id="fields" name="fields" value="">

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Update Form
            </button>
            <a href="{{ url_for('admin_registration_forms') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
let fields = [];
let existingFields = {{ form.fields | tojson }};

function addField(fieldData = null) {
    const fieldId = Date.now() + Math.random();
    const fieldHtml = `
        <div class="field-item" id="field-${fieldId}">
            <div class="field-header">
                <h4>Field ${fields.length + 1}</h4>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeField(${fieldId})">
                    <i class="fas fa-trash"></i> Remove
                </button>
            </div>
            <div class="field-body">
                <div class="row">
                    <div class="col-md-6">
                        <label>Field Name (internal) *</label>
                        <input type="text" class="form-control field-name" value="${fieldData?.name || ''}" required>
                    </div>
                    <div class="col-md-6">
                        <label>Field Label (display) *</label>
                        <input type="text" class="form-control field-label" value="${fieldData?.label || ''}" required>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-4">
                        <label>Field Type *</label>
                        <select class="form-control field-type" onchange="toggleOptions(${fieldId})">
                            <option value="text" ${fieldData?.type === 'text' ? 'selected' : ''}>Text</option>
                            <option value="email" ${fieldData?.type === 'email' ? 'selected' : ''}>Email</option>
                            <option value="tel" ${fieldData?.type === 'tel' ? 'selected' : ''}>Phone</option>
                            <option value="select" ${fieldData?.type === 'select' ? 'selected' : ''}>Dropdown</option>
                            <option value="textarea" ${fieldData?.type === 'textarea' ? 'selected' : ''}>Text Area</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>
                            <input type="checkbox" class="field-required" ${fieldData?.required ? 'checked' : ''}> Required
                        </label>
                    </div>
                    <div class="col-md-4 field-maxlength-container" style="display: ${fieldData?.type === 'textarea' ? 'block' : 'none'};">
                        <label>Max Length</label>
                        <input type="number" class="form-control field-maxlength" value="${fieldData?.maxlength || ''}">
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <label>Placeholder</label>
                        <input type="text" class="form-control field-placeholder" value="${fieldData?.placeholder || ''}">
                    </div>
                </div>
                <div class="row mt-2 field-options-container" style="display: ${fieldData?.type === 'select' ? 'block' : 'none'};">
                    <div class="col-md-12">
                        <label>Options (comma-separated)</label>
                        <input type="text" class="form-control field-options" value="${fieldData?.options?.join(', ') || ''}">
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('fieldsContainer').insertAdjacentHTML('beforeend', fieldHtml);
    fields.push(fieldId);
}

function removeField(fieldId) {
    document.getElementById(`field-${fieldId}`).remove();
    fields = fields.filter(id => id !== fieldId);
}

function toggleOptions(fieldId) {
    const fieldDiv = document.getElementById(`field-${fieldId}`);
    const typeSelect = fieldDiv.querySelector('.field-type');
    const optionsContainer = fieldDiv.querySelector('.field-options-container');
    const maxlengthContainer = fieldDiv.querySelector('.field-maxlength-container');
    
    if (typeSelect.value === 'select') {
        optionsContainer.style.display = 'block';
    } else {
        optionsContainer.style.display = 'none';
    }
    
    if (typeSelect.value === 'textarea') {
        maxlengthContainer.style.display = 'block';
    } else {
        maxlengthContainer.style.display = 'none';
    }
}

document.getElementById('registrationFormEditor').addEventListener('submit', function(e) {
    const fieldsData = [];
    
    document.querySelectorAll('.field-item').forEach(fieldDiv => {
        const field = {
            name: fieldDiv.querySelector('.field-name').value,
            label: fieldDiv.querySelector('.field-label').value,
            type: fieldDiv.querySelector('.field-type').value,
            required: fieldDiv.querySelector('.field-required').checked,
            placeholder: fieldDiv.querySelector('.field-placeholder').value
        };
        
        if (field.type === 'select') {
            const optionsStr = fieldDiv.querySelector('.field-options').value;
            field.options = optionsStr.split(',').map(o => o.trim()).filter(o => o);
        }
        
        if (field.type === 'textarea') {
            const maxlength = fieldDiv.querySelector('.field-maxlength').value;
            if (maxlength) {
                field.maxlength = parseInt(maxlength);
            }
        }
        
        fieldsData.push(field);
    });
    
    document.getElementById('fields').value = JSON.stringify(fieldsData);
});

// Load existing fields
existingFields.forEach(field => addField(field));

// If no fields, add one empty field
if (existingFields.length === 0) {
    addField();
}

function togglePaymentSettings() {
    const paymentEnabled = document.getElementById('paymentEnabled').checked;
    const paymentSettings = document.getElementById('paymentSettings');
    const paymentAmount = document.getElementById('paymentAmount');
    
    if (paymentEnabled) {
        paymentSettings.style.display = 'block';
        paymentAmount.required = true;
    } else {
        paymentSettings.style.display = 'none';
        paymentAmount.required = false;
    }
}
</script>

<style>
.form-container {
    max-width: 900px;
    margin: 0 auto;
}

.form-section {
    background: white;
    padding: 2rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-section h3 {
    margin-bottom: 1.5rem;
    color: #333;
}

.field-item {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
}

.field-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.field-header h4 {
    margin: 0;
    color: #495057;
}

.field-body .row {
    margin-bottom: 0.5rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    padding: 2rem;
}

.endpoint-row {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.btn-outline {
    background: transparent;
    border: 1px solid #ced4da;
    color: #495057;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    white-space: nowrap;
}

.btn-outline:hover {
    background: #f1f3f5;
}
</style>
    </div>
    
    <script src="{{ url_for('static', filename='js/admin-theme.js') }}"></script>
</body>
</html>
