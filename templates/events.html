{% extends "base.html" %}

{% block title %}Events - AI Coding Club{% endblock %}

{% block extra_head %}
<style>
/* Chatbot Styles */
.chat-fab {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.chat-fab.hidden { display: none; }

.chat-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
}

.chat-btn:hover { transform: scale(1.08); }
.chat-btn i { font-size: 24px; color: white; }

.chat-window {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 350px;
    max-width: calc(100vw - 40px);
    height: 450px;
    max-height: calc(100vh - 120px);
    background: #1a1a2e;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    display: none;
    flex-direction: column;
    overflow: hidden;
    z-index: 1001;
}

.chat-window.open { display: flex; }

.chat-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
}

.chat-title {
    color: white;
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-title i { font-size: 20px; }

.chat-close-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    min-width: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chat-close-btn:hover { background: rgba(255,255,255,0.3); }

.chat-quick {
    padding: 10px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    background: rgba(102, 126, 234, 0.1);
    flex-shrink: 0;
}

.chat-quick button {
    padding: 6px 12px;
    background: rgba(102, 126, 234, 0.2);
    border: 1px solid rgba(102, 126, 234, 0.3);
    border-radius: 14px;
    color: #a5b4fc;
    font-size: 12px;
    cursor: pointer;
}

.chat-quick button:hover {
    background: rgba(102, 126, 234, 0.4);
    color: white;
}

.chat-body {
    flex: 1;
    overflow-y: auto;
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    overscroll-behavior: contain;
    min-height: 0;
}

.chat-msg {
    max-width: 85%;
    padding: 10px 14px;
    border-radius: 14px;
    font-size: 14px;
    line-height: 1.5;
    word-wrap: break-word;
}

.chat-msg.bot {
    background: rgba(102, 126, 234, 0.2);
    color: #e2e8f0;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

.chat-msg.user {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

.chat-msg.typing {
    display: flex;
    gap: 5px;
    padding: 14px 18px;
}

.dot {
    width: 8px;
    height: 8px;
    background: #667eea;
    border-radius: 50%;
    animation: dotBounce 1s infinite ease-in-out;
}

.dot:nth-child(2) { animation-delay: 0.15s; }
.dot:nth-child(3) { animation-delay: 0.3s; }

@keyframes dotBounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-6px); }
}

.chat-input-wrap {
    padding: 12px;
    background: rgba(0,0,0,0.2);
    display: flex;
    gap: 10px;
    flex-shrink: 0;
}

.chat-input-wrap input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid rgba(102, 126, 234, 0.3);
    border-radius: 20px;
    background: rgba(255,255,255,0.05);
    color: white;
    font-size: 16px;
    outline: none;
}

.chat-input-wrap input:focus { border-color: #667eea; }
.chat-input-wrap input::placeholder { color: rgba(255,255,255,0.4); }

.chat-send-btn {
    width: 40px;
    height: 40px;
    min-width: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.chat-send-btn:hover:not(:disabled) { transform: scale(1.05); }
.chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.chat-send-btn i { color: white; font-size: 14px; }

.chat-body::-webkit-scrollbar { width: 4px; }
.chat-body::-webkit-scrollbar-thumb { background: rgba(102, 126, 234, 0.3); border-radius: 2px; }

/* Chat links */
.chat-link {
    color: #93c5fd;
    text-decoration: underline;
    text-decoration-color: rgba(147, 197, 253, 0.4);
    transition: color 0.2s;
}
.chat-link:hover {
    color: #bfdbfe;
    text-decoration-color: rgba(191, 219, 254, 0.7);
}

@media (max-width: 480px) {
    .chat-window {
        position: fixed;
        top: 0; right: 0; bottom: 0; left: 0;
        width: 100%; 
        height: 100%;
        max-height: none; 
        max-width: none;
        border-radius: 0;
    }
    .chat-fab { bottom: 15px; right: 15px; }
}
</style>
{% endblock %}

{% block content %}
<section class="page-header">
    <div class="container">
        <h1>Our <span class="gradient-text">Events</span></h1>
        <p>Explore our workshops, hackathons, and collaborative projects</p>
        
        <!-- Attendance Check Link - More Prominent -->
        <div class="mt-4">
            <a href="{{ url_for('attendance_check') }}" class="btn btn-primary btn-lg" style="display: inline-flex; align-items: center; gap: 10px; padding: 12px 30px; border-radius: 50px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                <i class="fas fa-clipboard-check"></i>
                <span>Check Your Attendance</span>
            </a>
        </div>
    </div>
</section>

<section class="section">
    <div class="container">
        <!-- Event Filter -->
        <div class="event-filter">
            <button class="filter-btn active" data-filter="all">All Events</button>
            <button class="filter-btn" data-filter="upcoming">Upcoming</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
        </div>

        <!-- Events Grid -->
        <div class="events-grid-full">
            {% for event in events %}
            <div class="event-card-full" data-status="{{ event.status }}">
                <div class="event-image-full">
                    <img src="{{ event.image | cache_bust }}" alt="{{ event.name }}" onerror="this.src='/static/img/poster/placeholder-image.png'">
                    <div class="event-overlay">
                        <span class="event-status {{ event.status }}">{{ event.status|upper }}</span>
                    </div>
                </div>
                <div class="event-content-full">
                    <h3>{{ event.name }}</h3>
                    <div class="event-meta-full">
                        <div class="meta-item">
                            <i class="far fa-calendar"></i>
                            <span>{{ event.date }}</span>
                        </div>
                        {% if event.time %}
                        <div class="meta-item">
                            <i class="far fa-clock"></i>
                            <span>{{ event.time }}</span>
                        </div>
                        {% endif %}
                        <div class="meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ event.location }}</span>
                        </div>
                        {% if event.registration_deadline %}
                        <div class="meta-item" style="color: #ff6b6b;">
                            <i class="fas fa-hourglass-half"></i>
                            <span><strong>Reg Deadline: {{ event.registration_deadline.date }}</strong></span>
                        </div>
                        {% endif %}
                    </div>
                    <p class="event-description-full">{{ event.description }}</p>
                    
                    <div class="event-actions">
                        <a href="/events/{{ event.id }}" class="btn btn-outline">View Details <i class="fas fa-arrow-right"></i></a>
                        {% if event.status == 'upcoming' %}
                            {% if event.registration_type == 'external' and event.register_link %}
                            <a href="{{ event.register_link }}" class="btn btn-primary">Register Now <i class="fas fa-arrow-right"></i></a>
                            {% elif event.registration_type == 'internal' %}
                            <a href="/events/{{ event.id }}/register" class="btn btn-primary">Register Now <i class="fas fa-arrow-right"></i></a>
                            {% endif %}
                        {% elif event.status == 'completed' %}
                        <span class="event-completed-badge"><i class="fas fa-check-circle"></i> Event Completed</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Chatbot -->
<div class="chat-fab" id="chatFab">
    <button class="chat-btn" id="chatBtn" title="Chat with AI">
        <i class="fas fa-comments"></i>
    </button>
</div>

<div class="chat-window" id="chatWindow">
    <div class="chat-header">
        <div class="chat-title"><i class="fas fa-robot"></i> AICC Assistant</div>
        <button class="chat-close-btn" id="chatClose"><i class="fas fa-times"></i></button>
    </div>
    <div class="chat-quick">
        <button data-msg="What events are upcoming?">üìÖ Events</button>
        <button data-msg="List all event links">üîó Event Links</button>
        <button data-msg="How do I register?">üìù Register</button>
        <button data-msg="Tell me about AICC">‚ÑπÔ∏è About</button>
    </div>
    <div class="chat-body" id="chatBody">
        <div class="chat-msg bot">Hey! üëã I'm your AICC Assistant. How can I help?</div>
    </div>
    <div class="chat-input-wrap">
        <input type="text" id="chatInput" placeholder="Type a message..." autocomplete="off">
        <button class="chat-send-btn" id="chatSend"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Event filtering
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const filter = btn.dataset.filter;
        document.querySelectorAll('.event-card-full').forEach(card => {
            card.style.display = (filter === 'all' || card.dataset.status === filter) ? 'flex' : 'none';
        });
    });
});

// Chatbot
const chatFab = document.getElementById('chatFab');
const chatBtn = document.getElementById('chatBtn');
const chatWindow = document.getElementById('chatWindow');
const chatClose = document.getElementById('chatClose');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');

// Conversation history for context (stores {role, content} objects)
const chatHistory = [];

function openChat() {
    chatFab.classList.add('hidden');
    chatWindow.classList.add('open');
    setTimeout(() => chatInput.focus(), 100);
}

function closeChat() {
    chatFab.classList.remove('hidden');
    chatWindow.classList.remove('open');
}

chatBtn.addEventListener('click', openChat);
chatClose.addEventListener('click', closeChat);
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeChat(); });

// Handle mobile keyboard resize
if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', () => {
        if (chatWindow.classList.contains('open')) {
            chatWindow.style.height = window.visualViewport.height + 'px';
            scrollChat();
        }
    });
}

// Quick buttons
document.querySelectorAll('.chat-quick button').forEach(btn => {
    btn.addEventListener('click', () => sendChat(btn.dataset.msg));
});

async function sendChat(msg) {
    const message = msg || chatInput.value.trim();
    if (!message) return;
    
    addMsg(message, 'user');
    chatHistory.push({ role: 'user', content: message });
    chatInput.value = '';
    chatSend.disabled = true;
    
    const typing = document.createElement('div');
    typing.className = 'chat-msg bot typing';
    typing.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    chatBody.appendChild(typing);
    scrollChat();
    
    try {
        // Send last 5 messages as history for context
        const historyToSend = chatHistory.slice(-5);
        const res = await fetch('/api/chatbot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message, history: historyToSend })
        });
        const data = await res.json();
        typing.remove();
        const reply = data.reply || 'Sorry, something went wrong.';
        addMsg(reply, 'bot');
        chatHistory.push({ role: 'assistant', content: reply });
    } catch (e) {
        typing.remove();
        addMsg('Connection error. Please try again.', 'bot');
    }
    chatSend.disabled = false;
}

function renderChatText(text) {
    // Escape HTML first
    let safe = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    // Convert [text](/path) links to clickable <a> tags
    safe = safe.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, '<a href="$2" class="chat-link" target="_self">$1</a>');
    // Convert plain /events/N paths to links (if not already inside an <a>)
    safe = safe.replace(/(?<!href=")(?<!")(\/(events\/\d+(?:\/register)?|events|gallery|members|about|attendance\/check))(?![^<]*<\/a>)/g, '<a href="$1" class="chat-link" target="_self">$1</a>');
    // Convert newlines to <br>
    safe = safe.replace(/\n/g, '<br>');
    return safe;
}

function addMsg(text, sender) {
    const div = document.createElement('div');
    div.className = 'chat-msg ' + sender;
    if (sender === 'bot') {
        div.innerHTML = renderChatText(text);
    } else {
        div.innerHTML = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
    }
    chatBody.appendChild(div);
    scrollChat();
}

function scrollChat() {
    chatBody.scrollTop = chatBody.scrollHeight;
}

chatSend.addEventListener('click', () => sendChat());
chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendChat(); });
</script>
{% endblock %}
